/*
    CyberGuardian AI - Malware Detection Rules
    Basic malware signatures
*/

rule Suspicious_Executable_Packer
{
    meta:
        description = "Detects packed/compressed executables"
        author = "CyberGuardian AI"
        severity = "medium"
        category = "malware"
    
    strings:
        $upx1 = "UPX0" ascii
        $upx2 = "UPX1" ascii
        $upx3 = "UPX!" ascii
        $aspack = "aPLib" ascii
        $petite = "petite" nocase
    
    condition:
        uint16(0) == 0x5A4D and  // MZ header
        any of them
}

rule Malware_Common_Strings
{
    meta:
        description = "Common malware strings and behaviors"
        author = "CyberGuardian AI"
        severity = "high"
        category = "malware"
    
    strings:
        $keylogger1 = "keylog" nocase
        $keylogger2 = "GetAsyncKeyState" ascii
        $backdoor1 = "backdoor" nocase
        $backdoor2 = "remote shell" nocase
        $c2_1 = "command and control" nocase
        $c2_2 = "C&C server" nocase
        $rootkit = "rootkit" nocase
        $persist1 = "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
        $persist2 = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
    
    condition:
        2 of them
}

rule Suspicious_API_Calls
{
    meta:
        description = "Suspicious Windows API usage"
        author = "CyberGuardian AI"
        severity = "medium"
        category = "malware"
    
    strings:
        $api1 = "VirtualAllocEx" ascii
        $api2 = "WriteProcessMemory" ascii
        $api3 = "CreateRemoteThread" ascii
        $api4 = "NtQueryInformationProcess" ascii
        $api5 = "IsDebuggerPresent" ascii
        $api6 = "ZwUnmapViewOfSection" ascii
    
    condition:
        uint16(0) == 0x5A4D and  // MZ header
        3 of them
}

rule Generic_Malware_Strings
{
    meta:
        description = "Generic malware indicators"
        author = "CyberGuardian AI"
        severity = "high"
        category = "malware"
    
    strings:
        $str1 = "payload" nocase
        $str2 = "exploit" nocase
        $str3 = "shellcode" nocase
        $str4 = "reverse_tcp" nocase
        $str5 = "meterpreter" nocase
        $str6 = "metasploit" nocase
        $str7 = "mimikatz" nocase
    
    condition:
        any of them
}

rule Obfuscated_PowerShell
{
    meta:
        description = "Detects obfuscated PowerShell scripts"
        author = "CyberGuardian AI"
        severity = "high"
        category = "malware"
    
    strings:
        $ps1 = "powershell" nocase
        $ps2 = "pwsh" nocase
        $enc1 = "-EncodedCommand" nocase
        $enc2 = "-enc" nocase
        $bypass = "-ExecutionPolicy Bypass" nocase
        $hidden = "-WindowStyle Hidden" nocase
        $nop = "-NoProfile" nocase
    
    condition:
        any of ($ps1, $ps2) and 2 of ($enc*, $bypass, $hidden, $nop)
}